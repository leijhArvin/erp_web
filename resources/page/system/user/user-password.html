<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>修改密码</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="../../../lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="../../../css/public.css" media="all">
    <style>
        .layui-form-item .layui-input-company {
            width: auto;
            padding-right: 10px;
            line-height: 38px;
        }

        .slide-verify {
            position: relative;
            width: 350px;
        }

        .slide-verify-block {
            position: absolute;
            top: 0;
            left: 0;
        }

        .slide-verify-slider {
            position: relative;
            width: 352px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            background: #f7f9fa;
            border: 1px solid #e4e7eb;
        }

        .canvas {
            border: 1px solid #e4e7eb;
        }

        .slide-verify-slider-mask {
            position: absolute;
            top: 0;
            left: 0;
            background: #d1e9fe;
        }

        .slide-verify-slider-mask-item {
            position: absolute;
            top: 0;
            left: 0;
            width: 38px;
            height: 38px;
            color: #fff;
            cursor: pointer;
            background: #1890ff;
            transition: background 0.2s linear;
        }

        .slide-verify-slider-mask-item:hover {
            background: #1890ff;
        }

        .slide-verify-slider-mask-item:hover .slide-verify-slider-mask-item-icon {
            background-position: 0 -13px;
        }

        .container-active .slide-verify-slider-mask-item {
        }

        .container-active .slide-verify-slider-mask {
        }

        .container-success .slide-verify-slider-mask-item {
            color: #fff;
            background-color: #13ce66 !important;
        }

        .container-success .slide-verify-slider-mask {
            background-color: #d2f4ef;
        }

        .container-success .slide-verify-slider-mask-item-icon {
            background-position: 0 0 !important;
        }

        .container-fail .slide-verify-slider-mask-item {
            color: #fff;
            background-color: #ff4d4f !important;
        }

        .container-fail .slide-verify-slider-mask {
            background-color: #fce1e1;
        }

        .container-fail .slide-verify-slider-mask-item-icon {
            top: 14px;
            background-position: 0 -82px !important;
        }

        .container-active .slide-verify-slider-text,
        .container-success .slide-verify-slider-text,
        .container-fail .slide-verify-slider-text {
            display: none;
        }

        .el-icon-arrow-right {
            margin-top: 12px;
            font-size: 20px;
        }

        .slide-verify-slider-mask-item:hover .el-icon-arrow-right {
            color: #fff;
        }
    </style>
    <link rel="stylesheet" href="../../../lib/plugin/iview/dist/styles/iview.css">
    <script src="../../../lib/plugin/vue/vue.min.js"></script>
    <script src="../../../lib/plugin/iview/dist/iview.min.js"></script>
    <script src="../../../lib/plugin/axios/axios.min.js"></script>
    <link rel="stylesheet" href="../../../js/lay-module/febs/css/febs.css">
</head>
<body>
<div class="layuimini-container" id="app">

    <div>
        <div id="slideVerify" class="slide-verify" onselectstart="return false;">
            <canvas ref="canvas" class="canvas" :width="w" :height="h"></canvas>
            <div class="slide-verify-refresh-icon" @click="refresh"></div>
            <canvas
                    ref="block"
                    :width="w"
                    :height="h"
                    class="slide-verify-block"
            ></canvas>
            <!-- container -->
            <div
                    class="slide-verify-slider"
                    :class="{
        'container-active': containerActive,
        'container-success': containerSuccess,
        'container-fail': containerFail,
      }"
            >
                <div class="slide-verify-slider-mask" :style="{ width: sliderMaskWidth }">
                    <!-- slider -->
                    <div
                            class="slide-verify-slider-mask-item"
                            :style="{ left: sliderLeft }"
                            @mousedown="sliderDown"
                            @touchstart="touchStartEvent"
                            @touchmove="touchMoveEvent"
                            @touchend="touchEndEvent"
                    >
                        <!-- <div class="slide-verify-slider-mask-item-icon"></div> -->
                        <i class="el-icon-arrow-right"></i>
                    </div>
                </div>
                <span class="slide-verify-slider-text">{{ sliderText }}</span>
            </div>
        </div>
    </div>

    <div class="layuimini-main">

        <div class="layui-form layuimini-form">
            <div class="layui-form-item">
                <label class="layui-form-label required">旧的密码</label>
                <div class="layui-input-block">
                    <input type="password" name="old_password" id="old_password" lay-verify="required"
                           lay-reqtext="旧的密码不能为空" placeholder="请输入旧的密码" value="" class="layui-input">
                    <tip>填写自己账号的旧的密码。</tip>
                </div>
            </div>

            <div class="layui-form-item">
                <label class="layui-form-label required">新的密码</label>
                <div class="layui-input-block">
                    <input type="password" name="new_password" lay-verify="required" lay-reqtext="新的密码不能为空"
                           placeholder="请输入新的密码" value="" class="layui-input">
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label required">新的密码</label>
                <div class="layui-input-block">
                    <input type="password" name="again_password" lay-verify="required" lay-reqtext="新的密码不能为空"
                           placeholder="请输入新的密码" value="" class="layui-input">
                </div>
            </div>

            <div class="layui-form-item">
                <div class="layui-input-block">
                    <div class="verify-container">
                        <byui-verify
                                ref="slideDiv"
                                :w="350"
                                :slider-text="text"
                                :h="175"
                                @success="handleSuccess"
                                @fail="handleError"
                        ></byui-verify>
                    </div>
                    <button class="layui-btn" lay-submit lay-filter="saveBtn">确认保存</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="../../../lib/jquery-3.4.1/jquery-3.4.1.min.js" charset="utf-8"></script>
<script src="../../../lib/common/jquery.cookie.min.js" charset="utf-8"></script>
<script src="../../../lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="../../../lib/common/common.js" charset="utf-8"></script>
<script>
    // http request 拦截器
    axios.interceptors.request.use(
        config => {
            if (token) { //判断token是否存在
                config.headers.token = $.cookie("TOKEN");  //将token设置成请求头
            }
            return config;
        },
        err => {
            return Promise.reject(err);
        }
    );

    let vue;
    layui.use(['form', 'table', 'layer'], function () {
        var $ = layui.jquery,
            form = layui.form,
            table = layui.table,
            layer = layui.layer;

        //监听提交
        form.on('submit(saveBtn)', function (data) {
            let str = JSON.stringify(data.field);
            let obj = JSON.parse(str);

            if (obj.new_password === obj.again_password) {
                let data = "oldPwd=" + obj.old_password + "&newPwd=" + obj.again_password;
                axios.post(api + "user/updatePassword", data).then(res => {
                    if (res.data.code == 200) {
                        vue.$Message.success(res.data.msg);
                        $.cookie('TOKEN', '', {expires: 0});

                        setTimeout(function () {
                            window.location = loginUrl;
                        }, 1000);
                    }
                }).catch(err => {
                    layer.msg(res.data.msg);
                });
            } else {
                vue.$Message.warning(res.data.msg);
            }
            return false;
        });

    });

    const PI = Math.PI;

    function sum(x, y) {
        return x + y;
    }

    function square(x) {
        return x * x;
    }

    vue = new Vue({
        el: "#app",
        data: {
            text: "向右滑动",
            containerActive: false,
            containerSuccess: false,
            containerFail: false,
            canvasCtx: null,
            blockCtx: null,
            block: null,
            block_x: undefined,
            block_y: undefined,
            L: this.l + this.r * 2 + 3,
            img: undefined,
            originX: undefined,
            originY: undefined,
            isMouseDown: false,
            trail: [],
            sliderLeft: 0,
            sliderMaskWidth: 0,
        },
        props: {
            l: {
                type: Number,
                default: 42,
            },
            r: {
                type: Number,
                default: 10,
            },
            w: {
                type: Number,
                default: 310,
            },
            h: {
                type: Number,
                default: 155,
            },
            sliderText: {
                type: String,
                default: "Slide filled right",
            },
        },
        mounted() {
            this.init();
        },
        methods: {
            init() {
                this.initDom();
                this.initImg();
                this.bindEvents();
            },
            initDom() {
                this.block = this.$refs.block;
                this.canvasCtx = this.$refs.canvas.getContext("2d");
                this.blockCtx = this.block.getContext("2d");
            },
            initImg() {
                const img = this.createImg(() => {
                    this.drawBlock();
                    this.canvasCtx.drawImage(img, 0, 0, this.w, this.h);
                    this.blockCtx.drawImage(img, 0, 0, this.w, this.h);
                    let {block_x: x, block_y: y, r, L} = this;
                    let _y = y - r * 2 - 1;
                    let ImageData = this.blockCtx.getImageData(x, _y, L, L);
                    this.block.width = L;
                    this.blockCtx.putImageData(ImageData, 0, _y);
                });
                this.img = img;
            },
            drawBlock() {
                this.block_x = this.getRandomNumberByRange(
                    this.L + 10,
                    this.w - (this.L + 10)
                );
                this.block_y = this.getRandomNumberByRange(
                    10 + this.r * 2,
                    this.h - (this.L + 10)
                );
                this.draw(this.canvasCtx, this.block_x, this.block_y, "fill");
                this.draw(this.blockCtx, this.block_x, this.block_y, "clip");
            },
            draw(ctx, x, y, operation) {
                let {l, r} = this;
                ctx.beginPath();
                ctx.moveTo(x, y);
                ctx.arc(x + l / 2, y - r + 2, r, 0.72 * PI, 2.26 * PI);
                ctx.lineTo(x + l, y);
                ctx.arc(x + l + r - 2, y + l / 2, r, 1.21 * PI, 2.78 * PI);
                ctx.lineTo(x + l, y + l);
                ctx.lineTo(x, y + l);
                ctx.arc(x + r - 2, y + l / 2, r + 0.4, 2.76 * PI, 1.24 * PI, true);
                ctx.lineTo(x, y);
                ctx.lineWidth = 2;
                ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
                ctx.strokeStyle = "rgba(255, 255, 255, 0.8)";
                ctx.stroke();
                ctx[operation]();
                ctx.globalCompositeOperation = "xor";
            },
            createImg(onload) {
                const img = document.createElement("img");
                img.crossOrigin = "Anonymous";
                img.onload = onload;
                img.onerror = () => {
                    img.src = this.getRandomImg();
                };
                img.src = this.getRandomImg();
                return img;
            },
            getRandomImg() {
                return (
                    "https://picsum.photos/350/170/?image=" +
                    this.getRandomNumberByRange(0, 50)
                );
            },
            getRandomNumberByRange(start, end) {
                return Math.round(Math.random() * (end - start) + start);
            },
            refresh() {
                this.reset();
                this.$emit("refresh");
            },
            sliderDown(event) {
                this.originX = event.clientX;
                this.originY = event.clientY;
                this.isMouseDown = true;
            },
            touchStartEvent(e) {
                this.originX = e.changedTouches[0].pageX;
                this.originY = e.changedTouches[0].pageY;
                this.isMouseDown = true;
            },
            bindEvents() {
                document.addEventListener("mousemove", (e) => {
                    if (!this.isMouseDown) return false;
                    const moveX = e.clientX - this.originX;
                    const moveY = e.clientY - this.originY;
                    if (moveX < 0 || moveX + 38 >= this.w) return false;
                    this.sliderLeft = moveX + "px";
                    let blockLeft = ((this.w - 40 - 20) / (this.w - 40)) * moveX;
                    this.block.style.left = blockLeft + "px";
                    this.containerActive = true;
                    this.sliderMaskWidth = moveX + "px";
                    this.trail.push(moveY);
                });
                document.addEventListener("mouseup", (e) => {
                    if (!this.isMouseDown) return false;
                    this.isMouseDown = false;
                    if (e.clientX === this.originX) return false;
                    this.containerActive = false;
                    const {spliced, TuringTest} = this.verify();
                    if (spliced) {
                        if (TuringTest) {
                            this.containerSuccess = true;
                            this.$emit("success");
                        } else {
                            this.containerFail = true;
                            this.sliderText = "try again";
                            this.reset();
                        }
                    } else {
                        this.containerFail = true;
                        this.$emit("fail");
                        setTimeout(() => {
                            this.reset();
                        }, 1000);
                    }
                });
            },
            touchMoveEvent(e) {
                if (!this.isMouseDown) return false;
                const moveX = e.changedTouches[0].pageX - this.originX;
                const moveY = e.changedTouches[0].pageY - this.originY;
                if (moveX < 0 || moveX + 38 >= this.w) return false;
                this.sliderLeft = moveX + "px";
                let blockLeft = ((this.w - 40 - 20) / (this.w - 40)) * moveX;
                this.block.style.left = blockLeft + "px";
                this.containerActive = true;
                this.sliderMaskWidth = moveX + "px";
                this.trail.push(moveY);
            },
            touchEndEvent(e) {
                if (!this.isMouseDown) return false;
                this.isMouseDown = false;
                if (e.changedTouches[0].pageX === this.originX) return false;
                this.containerActive = false;
                const {spliced, TuringTest} = this.verify();
                if (spliced) {
                    if (TuringTest) {
                        this.containerSuccess = true;
                        this.$emit("success");
                    } else {
                        this.containerFail = true;
                        this.sliderText = "try again";
                        this.reset();
                    }
                } else {
                    this.containerFail = true;
                    this.$emit("fail");
                    setTimeout(() => {
                        this.reset();
                    }, 1000);
                }
            },
            verify() {
                const arr = this.trail;
                const average = arr.reduce(sum) / arr.length;
                const deviations = arr.map((x) => x - average);
                const stddev = Math.sqrt(deviations.map(square).reduce(sum) / arr.length);
                const left = parseInt(this.block.style.left);
                return {
                    spliced: Math.abs(left - this.block_x) < 10,
                    TuringTest: average !== stddev,
                };
            },
            reset() {
                this.containerActive = false;
                this.containerSuccess = false;
                this.containerFail = false;
                this.sliderLeft = 0;
                this.block.style.left = 0;
                this.sliderMaskWidth = 0;
                let {w, h} = this;
                this.canvasCtx.clearRect(0, 0, w, h);
                this.blockCtx.clearRect(0, 0, w, h);
                this.block.width = w;
                this.img.src = this.getRandomImg();
            },

            handleSuccess() {
                this.$baseMessage("校验成功", "success");
            },
            handleError() {
                this.$baseMessage("校验失败", "error");
            },
        }
    });
</script>
</body>
</html>
