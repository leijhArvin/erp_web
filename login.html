<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>进销存系统</title>
    <link rel="icon" href="resources/images/favicon.ico">
    <link rel="stylesheet" href="resources/lib/layui-v2.5.5/css/layui.css" media="all">
    <!--element-ui/css-->
    <link rel="stylesheet" href="resources/lib/plugin/element-ui/style/index.css">
    <!--[if lt IE 9]>
    <script src="resources/lib/plugin/login/html5.min.js"></script>
    <script src="resources/lib/plugin/login/respond.min.js"></script>
    <![endif]-->

    <link rel="stylesheet" href="resources/js/lay-module/PearAdmin/css/pearForm.css"/>
    <link rel="stylesheet" href="resources/js/lay-module/PearAdmin/css/pearButton.css"/>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden
        }

        body {
            height: 100%;
        }

        body:after {
            content: '';
            background-repeat: no-repeat;
            background-size: cover;
            -webkit-filter: blur(3px);
            -moz-filter: blur(3px);
            -o-filter: blur(3px);
            -ms-filter: blur(3px);
            filter: blur(3px);
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: -1;
        }

        .layui-container {
            width: 100%;
            height: 100%;
            overflow: hidden
        }

        .admin-login-background {
            width: 360px;
            height: 300px;
            position: absolute;
            left: 50%;
            top: 40%;
            margin-left: -180px;
            margin-top: -100px;
        }

        .logo-title {
            text-align: center;
            letter-spacing: 2px;
            padding: 14px 0;
        }

        .logo-title h1 {
            font-weight: 600;
            color: rgba(0, 0, 0, .85);
        }

        .login-form .layui-form-item {
            position: relative;
        }

        .login-form .layui-form-item label {
            position: absolute;
            left: 1px;
            top: 1px;
            width: 38px;
            line-height: 36px;
            text-align: center;
            color: #d2d2d2;
        }

        .login-form .layui-form-item input {
            padding-left: 36px;
        }

        .layui-form {
            width: 330px;
            margin: auto;
            margin-top: 180px;
            box-sizing: border-box;
        }

        .captcha {
            width: 200px !important;
            display: inline-block;
        }

        .captcha-img {
            display: inline-block;
            width: 34%;
            height: 42px;
            float: right;
        }

        .captcha-img img {
            height: 42px;
            width: 100%;
        }

        #login {
            background-color: #1890ff;
            -webkit-border-radius: 3px;
            -moz-border-radius: 3px;
            border-radius: 3px;
        }

        #captchaPic {
            cursor: pointer;
        }

        .layui-form button {
            width: 100%;
            height: 44px;
            line-height: 44px;
            font-size: 16px;
            font-weight: 550;
        }

        .layui-form-checked[lay-skin=primary] i {
            border-color: #2D8CF0 !important;
            background-color: #2D8CF0;
            color: #fff;
        }

        .layui-tab-content {
            margin-top: 15px;
            padding-left: 0px;
            padding-right: 0px;
        }

        .layui-form-item {
            margin-top: 20px;
        }

        .layui-input {
            height: 44px;
            line-height: 44px;
            padding-left: 15px;
            border-radius: 3px;
        }

        .layui-input:focus {
            box-shadow: 0px 0px 3px 1px #2D8CF0 !important;
        }

        .logo {
            width: 60px;
            margin-top: 10px;
            margin-bottom: 10px;
            margin-left: 20px;
        }

        .title {
            font-size: 30px;
            font-weight: 550;
            margin-left: 20px;
            color: #2D8CF0 !important;
            display: inline-block;
            height: 60px;
            line-height: 60px;
            margin-top: 10px;
            position: absolute;
        }

        .desc {
            width: 100%;
            text-align: center;
            color: gray;
            height: 60px;
            line-height: 60px;
        }
    </style>
</head>
<body background="resources/js/lay-module/PearAdmin/images/background.svg" onload="getCookie();">

<div class="layui-container" id="app">
    <form class="layui-form login-form" action="javascript:void(0);">
        <div class="layui-form-item">
            <img class="logo" src="resources/js/lay-module/PearAdmin/images/logo.png"/>
            <div class="title">Erp Admin</div>
            <div class="desc">
                Erp Admin 分 布 式 微 服 务 系 统
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-icon layui-icon-username" for="username"></label>
            <input type="text" name="username" id="username" lay-verify="required" placeholder="账 户"
                   autocomplete="off"
                   class="layui-input" value="">
        </div>
        <div class="layui-form-item">
            <label class="layui-icon layui-icon-password" for="password"></label>
            <input type="password" name="password" hover id="password" lay-verify="required" placeholder="密 码"
                   autocomplete="off"
                   class="layui-input" value="">
        </div>
        <div class="layui-form-item">
            <label class="layui-icon layui-icon-vercode" for="captcha"></label>
            <input type="text" name="captcha" lay-verify="required" placeholder="图形验证码" autocomplete="off"
                   class="layui-input verification captcha" value="">
            <div class="captcha-img">
                <img id="captchaPic" onclick="genCode()">
            </div>
        </div>
        <div class="layui-form-item">
            <input type="checkbox" name="" title="记住密码" id="rememberMe" name="rememberMe" value="true"
                   lay-skin="primary" checked>
        </div>
        <div class="layui-form-item">
            <button class="pear-btn pear-btn-primary login" lay-submit="" lay-filter="login" id="login">
                立 即 登 录
            </button>
        </div>
    </form>
</div>

<script src="resources/lib/jquery-3.4.1/jquery-3.4.1.min.js" charset="utf-8"></script>
<script src="resources/lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
<script src="resources/lib/jq-module/jquery.particleground.min.js" charset="utf-8"></script>
<script src="resources/lib/common/jquery.cookie.min.js" type="text/javascript" charset="utf-8"></script>
<script src="resources/lib/common/common.js" type="text/javascript" charset="utf-8"></script>
<script src="resources/lib/common/jquery.base64.js"></script>

<!--vue-->
<script src="resources/lib/plugin/vue/vue.min.js"></script>
<!--element-ui/index.js-->
<script src="resources/lib/plugin/element-ui/index.js"></script>

<script>
    let vue;

    //写验证码
    let keyCode = Math.floor(Math.random() * 9000 + 1000);
    // $("#captchaPic").attr("src", api + 'login/captcha?codeKey=' + keyCode)

    function genCode() {
        keyCode = Math.floor(Math.random() * 9000 + 1000);
        // 获取验证码
        $.get(api + 'login/captcha?codeKey=' + keyCode, function (res) {
            // $("#captchaPic").attr("src", api + 'login/captcha?codeKey=' + keyCode)
            $("#captchaPic").attr("src", res.msg);
        }, 'json')
    }

    genCode();

    $(function () {
        $("#username").focus();

        let pwd = $.cookie("pwd"); //获取cookie中的登陆密码

        if (pwd) {//密码存在的话把“记住用户名和密码”复选框勾选住
            $("#rememberMe").attr("checked", "checked");
        }

        // 初始化Vue
        vue = new Vue({
            // 控制区域
            el: '#app',
        });
    })

    layui.use(['form'], function () {
        var form = layui.form,
            layer = layui.layer;

        // 登录过期的时候，跳出ifram框架
        if (top.location != self.location) top.location = self.location;

        // 进行登录操作
        form.on('submit(login)', function (data) {
            setCookie();

            // 发送Ajax请求去后台进行  认证
            let btn = $(this);
            btn.html(`登 录 中 <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i>`).attr("disabled", "disabled").addClass("layui-disabled");

            $.ajax({
                url: api + "login/doLogin",
                method: "post",
                data: {
                    loginname: data.field.username,
                    password: data.field.password,
                    captcha: data.field.captcha,
                    keyCode: keyCode
                },
                success: function (res) {
                    if (res.code != 200) {
                        vue.$message.error(res.msg);
                        btn.text("登 录").attr("disabled", false).removeClass("layui-disabled");
                    } else {
                        vue.$message({
                            message: '登录成功!',
                            type: 'success'
                        });
                        setTimeout(function () {
                            //把token写到cookie
                            $.cookie('TOKEN', res.token.token, {expires: 7});  //登陆成功这后把token放到cookie里面
                            localStorage.setItem("permissions", res.token.permissions);
                            localStorage.setItem("usertype", res.token.usertype);
                            localStorage.setItem("user", JSON.stringify(res.token.user));
                            window.location.href = "./index.html";
                        }, 2000);
                    }
                },
                error: function () {
                    vue.$message.error('登录失败');
                    btn.html("登 录").attr("disabled", "").removeClass("layui-disabled");
                }
            });

            return false;
        });
    });

    function setCookie() { //设置cookie
        let username = $("#username").val(); //获取用户名信息
        let pwd = $("#password").val(); //获取登陆密码信息
        let checked = $("#rememberMe").prop("checked");//获取“是否记住密码”复选框

        if (checked) { //判断是否选中了“记住密码”复选框
            $.cookie("username", username);//调用jquery.cookie.js中的方法设置cookie中的用户名
            $.cookie("pwd", $.base64.encode(pwd), {expires: 7});//调用jquery.cookie.js中的方法设置cookie中的登陆密码，并使用base64（jquery.base64.js）进行加密
        } else {
            $.cookie("username", '', {expires: 0});
            $.cookie('pwd', '', {expires: 0});
        }
    }
    function getCookie() { //获取cookie
        let username = $.cookie("username"); //获取cookie中的用户名
        let pwd = $.cookie("pwd"); //获取cookie中的登陆密码
        if (username) {//用户名存在的话把用户名填充到用户名文本框
            $("#username").val(username);
        }
        if (pwd) {//密码存在的话把密码填充到密码文本框
            $("#password").val($.base64.decode(pwd));
        }
    }
</script>
</body>
</html>
